<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecommerce.loadtest.dao.ProductMapper">

    <resultMap id="BaseResultMap" type="com.ecommerce.loadtest.entity.Product">
        <id column="product_id" jdbcType="BIGINT" property="productId"/>
        <result column="product_name" jdbcType="VARCHAR" property="productName"/>
        <result column="category_id" jdbcType="INTEGER" property="categoryId"/>
        <result column="category_name" jdbcType="VARCHAR" property="categoryName"/>
        <result column="business_line_id" jdbcType="INTEGER" property="businessLineId"/>
        <result column="price" jdbcType="DECIMAL" property="price"/>
        <result column="status" jdbcType="INTEGER" property="status"/>
        <result column="stock_count" jdbcType="INTEGER" property="stockCount"/>
        <result column="description" jdbcType="VARCHAR" property="description"/>
        <result column="image_url" jdbcType="VARCHAR" property="imageUrl"/>
        <result column="seller_id" jdbcType="BIGINT" property="sellerId"/>
        <result column="seller_name" jdbcType="VARCHAR" property="sellerName"/>
        <result column="tags" jdbcType="VARCHAR" property="tags"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        product_id, product_name, category_id, category_name, business_line_id, price, 
        status, stock_count, description, image_url, seller_id, seller_name, tags, 
        create_time, update_time
    </sql>

    <delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
        DELETE FROM product_info WHERE product_id = #{productId,jdbcType=BIGINT}
    </delete>

    <insert id="insertSelective" parameterType="com.ecommerce.loadtest.entity.Product">
        INSERT INTO product_info
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="productId != null">product_id,</if>
            <if test="productName != null">product_name,</if>
            <if test="categoryId != null">category_id,</if>
            <if test="categoryName != null">category_name,</if>
            <if test="businessLineId != null">business_line_id,</if>
            <if test="price != null">price,</if>
            <if test="status != null">status,</if>
            <if test="stockCount != null">stock_count,</if>
            <if test="description != null">description,</if>
            <if test="imageUrl != null">image_url,</if>
            <if test="sellerId != null">seller_id,</if>
            <if test="sellerName != null">seller_name,</if>
            <if test="tags != null">tags,</if>
            create_time,
            update_time
        </trim>
        <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
            <if test="productId != null">#{productId,jdbcType=BIGINT},</if>
            <if test="productName != null">#{productName,jdbcType=VARCHAR},</if>
            <if test="categoryId != null">#{categoryId,jdbcType=INTEGER},</if>
            <if test="categoryName != null">#{categoryName,jdbcType=VARCHAR},</if>
            <if test="businessLineId != null">#{businessLineId,jdbcType=INTEGER},</if>
            <if test="price != null">#{price,jdbcType=DECIMAL},</if>
            <if test="status != null">#{status,jdbcType=INTEGER},</if>
            <if test="stockCount != null">#{stockCount,jdbcType=INTEGER},</if>
            <if test="description != null">#{description,jdbcType=VARCHAR},</if>
            <if test="imageUrl != null">#{imageUrl,jdbcType=VARCHAR},</if>
            <if test="sellerId != null">#{sellerId,jdbcType=BIGINT},</if>
            <if test="sellerName != null">#{sellerName,jdbcType=VARCHAR},</if>
            <if test="tags != null">#{tags,jdbcType=VARCHAR},</if>
            NOW(),
            NOW()
        </trim>
    </insert>

    <select id="selectByPrimaryKey" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        WHERE product_id = #{productId,jdbcType=BIGINT}
    </select>

    <update id="updateByPrimaryKeySelective" parameterType="com.ecommerce.loadtest.entity.Product">
        UPDATE product_info
        <set>
            <if test="productName != null">product_name = #{productName,jdbcType=VARCHAR},</if>
            <if test="categoryId != null">category_id = #{categoryId,jdbcType=INTEGER},</if>
            <if test="categoryName != null">category_name = #{categoryName,jdbcType=VARCHAR},</if>
            <if test="businessLineId != null">business_line_id = #{businessLineId,jdbcType=INTEGER},</if>
            <if test="price != null">price = #{price,jdbcType=DECIMAL},</if>
            <if test="status != null">status = #{status,jdbcType=INTEGER},</if>
            <if test="stockCount != null">stock_count = #{stockCount,jdbcType=INTEGER},</if>
            <if test="description != null">description = #{description,jdbcType=VARCHAR},</if>
            <if test="imageUrl != null">image_url = #{imageUrl,jdbcType=VARCHAR},</if>
            <if test="sellerId != null">seller_id = #{sellerId,jdbcType=BIGINT},</if>
            <if test="sellerName != null">seller_name = #{sellerName,jdbcType=VARCHAR},</if>
            <if test="tags != null">tags = #{tags,jdbcType=VARCHAR},</if>
            update_time = NOW()
        </set>
        WHERE product_id = #{productId,jdbcType=BIGINT}
    </update>

    <select id="selectProductsByConditions" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        <where>
            <if test="categoryId != null">
                AND category_id = #{categoryId,jdbcType=INTEGER}
            </if>
            <if test="businessLineId != null">
                AND business_line_id = #{businessLineId,jdbcType=INTEGER}
            </if>
            <if test="minPrice != null">
                AND price &gt;= #{minPrice,jdbcType=DECIMAL}
            </if>
            <if test="maxPrice != null">
                AND price &lt;= #{maxPrice,jdbcType=DECIMAL}
            </if>
            <if test="status != null">
                AND status = #{status,jdbcType=INTEGER}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (product_name LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%')
                     OR description LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%'))
            </if>
        </where>
        ORDER BY create_time DESC
        <if test="pageNo != null and pageSize != null">
            LIMIT #{pageSize,jdbcType=INTEGER} OFFSET #{pageNo,jdbcType=INTEGER}
        </if>
    </select>

    <select id="selectProductsByIds" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        WHERE product_id IN
        <foreach collection="productIds" item="productId" open="(" separator="," close=")">
            #{productId,jdbcType=BIGINT}
        </foreach>
        ORDER BY create_time DESC
    </select>

    <select id="selectPopularProducts" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        <where>
            status = 1
            <if test="businessLineId != null">AND business_line_id = #{businessLineId,jdbcType=INTEGER}</if>
        </where>
        ORDER BY stock_count DESC, create_time DESC
        <if test="limit != null and limit > 0">LIMIT #{limit}</if>
    </select>

    <select id="selectProductsByPriceRange" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        <where>
            status = 1
            <if test="minPrice != null">AND price >= #{minPrice,jdbcType=DECIMAL}</if>
            <if test="maxPrice != null">AND price &lt;= #{maxPrice,jdbcType=DECIMAL}</if>
            <if test="businessLineId != null">AND business_line_id = #{businessLineId,jdbcType=BIGINT}</if>
        </where>
        ORDER BY price ASC
        <if test="limit != null and limit > 0">LIMIT #{limit}</if>
    </select>

    <select id="selectProductsByCategory" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        <where>
            <if test="categoryId != null">category_id = #{categoryId,jdbcType=BIGINT}</if>
            <if test="status != null">AND status = #{status,jdbcType=INTEGER}</if>
        </where>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">LIMIT #{limit}</if>
    </select>

    <select id="selectProductsByBusinessLine" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM product_info
        <where>
            <if test="businessLineId != null">business_line_id = #{businessLineId,jdbcType=BIGINT}</if>
            <if test="status != null">AND status = #{status,jdbcType=INTEGER}</if>
        </where>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">LIMIT #{limit}</if>
    </select>

    <select id="selectProductStatistics" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_count,
            COUNT(CASE WHEN status = 1 THEN 1 END) as active_count,
            COUNT(CASE WHEN status = 0 THEN 1 END) as inactive_count,
            AVG(price) as avg_price,
            MIN(price) as min_price,
            MAX(price) as max_price,
            SUM(stock_count) as total_stock
        FROM product_info
        <where>
            <if test="businessLineId != null">business_line_id = #{businessLineId,jdbcType=BIGINT}</if>
        </where>
    </select>

    <select id="selectCategoryStatistics" resultType="java.util.Map">
        SELECT
            category_id,
            category_name,
            COUNT(*) as product_count,
            AVG(price) as avg_price,
            SUM(stock_count) as total_stock
        FROM product_info
        WHERE status = 1
        GROUP BY category_id, category_name
        ORDER BY product_count DESC
    </select>

    <select id="selectPriceDistribution" resultType="java.util.Map">
        SELECT
            CASE
                WHEN price &lt; 1000 THEN '0-10元'
                WHEN price &lt; 5000 THEN '10-50元'
                WHEN price &lt; 10000 THEN '50-100元'
                WHEN price &lt; 50000 THEN '100-500元'
                ELSE '500元以上'
            END as price_range,
            COUNT(*) as product_count,
            AVG(price) as avg_price
        FROM product_info
        <where>
            status = 1
            <if test="businessLineId != null">AND business_line_id = #{businessLineId,jdbcType=BIGINT}</if>
        </where>
        GROUP BY price_range
        ORDER BY MIN(price)
    </select>

    <select id="selectProductIdsByBatch" resultType="java.lang.Long">
        SELECT product_id
        FROM product_info
        <where>
            <if test="status != null">status = #{status,jdbcType=INTEGER}</if>
            <if test="categoryIds != null and categoryIds.size() > 0">
                AND category_id IN
                <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
                    #{categoryId,jdbcType=BIGINT}
                </foreach>
            </if>
            <if test="businessLineIds != null and businessLineIds.size() > 0">
                AND business_line_id IN
                <foreach collection="businessLineIds" item="businessLineId" open="(" separator="," close=")">
                    #{businessLineId,jdbcType=BIGINT}
                </foreach>
            </if>
        </where>
        ORDER BY create_time DESC
        <if test="limit != null and limit > 0">LIMIT #{limit}</if>
    </select>

</mapper>
